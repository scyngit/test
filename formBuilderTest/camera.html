<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>getUserMedia Demo</title>
</head>
<body>
  <video autoplay playsinline></video>
  <br>
  <button id="switch">ğŸ”„ åˆ‡æ¢æ‘„åƒå¤´</button>
  <button id="start">ğŸ¬ å¼€å§‹å½•åˆ¶</button>
  <button id="stop" disabled>ğŸ›‘ åœæ­¢å½•åˆ¶</button>
  <a id="downloadLink" style="display:none;">â¬‡ï¸ ä¸‹è½½è§†é¢‘</a>
  <br><br>
  <button id="capture">ğŸ“¸ æ‹ç…§</button>
  <canvas></canvas>
</body>
</html>

<script>
const video = document.querySelector('video');
const canvas = document.querySelector('canvas');
const captureBtn = document.getElementById('capture');
const startBtn = document.getElementById('start');
const stopBtn = document.getElementById('stop');
const switchBtn = document.getElementById('switch');
const downloadLink = document.getElementById('downloadLink');

let stream;
let mediaRecorder;
let recordedChunks = [];
let currentDeviceId = null;
let videoDevices = [];
let currentDeviceIndex = 0;

// è·å–æ‰€æœ‰æ‘„åƒå¤´è®¾å¤‡
navigator.mediaDevices.enumerateDevices().then(devices => {

    devices.forEach(device => {
       alert(`${device.kind}: ${device.label} (${device.deviceId})`);
    });
  videoDevices = devices.filter(d => d.kind === 'videoinput');
  startStream(videoDevices[0]?.deviceId); // é»˜è®¤å¯åŠ¨ç¬¬ä¸€ä¸ª
});

function startStream(deviceId) {
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
  }

  const constraints = {
    video: { deviceId: deviceId ? { exact: deviceId } : undefined },
    audio: true
  };

  navigator.mediaDevices.getUserMedia(constraints).then(s => {
    stream = s;
    video.srcObject = stream;
    currentDeviceId = deviceId;
  }).catch(e => {
    console.error('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼š', e);
    alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼š' + e.message);
  });
}

// åˆ‡æ¢æ‘„åƒå¤´æŒ‰é’®
switchBtn.onclick = () => {
  if (videoDevices.length < 2) {
    alert('åªæ£€æµ‹åˆ°ä¸€ä¸ªæ‘„åƒå¤´ï¼Œæ— æ³•åˆ‡æ¢');
    return;
  }
  currentDeviceIndex = (currentDeviceIndex + 1) % videoDevices.length;
  const nextDeviceId = videoDevices[currentDeviceIndex].deviceId;
  startStream(nextDeviceId);
};

// æ‹ç…§
captureBtn.onclick = () => {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0);
};

// å¼€å§‹å½•åˆ¶
startBtn.onclick = () => {
  recordedChunks = [];
  mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });

  mediaRecorder.ondataavailable = e => {
    if (e.data.size > 0) recordedChunks.push(e.data);
  };

  mediaRecorder.onstop = () => {
    const blob = new Blob(recordedChunks, { type: 'video/webm' });
    const url = URL.createObjectURL(blob);
    downloadLink.href = url;
    downloadLink.download = 'recorded.webm';
    downloadLink.style.display = 'inline-block';
    downloadLink.textContent = 'â¬‡ï¸ ä¸‹è½½è§†é¢‘';
  };

  mediaRecorder.start();
  startBtn.disabled = true;
  stopBtn.disabled = false;
  downloadLink.style.display = 'none';
};

// åœæ­¢å½•åˆ¶
stopBtn.onclick = () => {
  mediaRecorder.stop();
  startBtn.disabled = false;
  stopBtn.disabled = true;
};
</script>
